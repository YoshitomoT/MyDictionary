<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.app.mapper.WordMapper">
	
	<select id="selectAll" parameterType="Integer" resultType="Word">
		SELECT 
			* 
		FROM 
			words
		WHERE 
			user_id = #{userId}
	</select>
	
	<select id="selectAllWithDict" resultMap="joinedResult">
		SELECT 
			 dictionarys.id AS dictionary_id, dictionarys.name AS dictionary_name,
		     words.id AS id, words.name AS name, pronunciation, simple_description, detailed_description, reference_url,
		     registered_at, updated_at, last_view_at, page_views
		FROM 
			words
		JOIN
			dictionary_word
		ON
			 words.id = dictionary_word.word_id
		JOIN
			dictionarys
		ON
			dictionary_word.dictionary_id = dictionarys.id

	</select>
	<resultMap type="Word" id="joinedResult" autoMapping="true">
		<id property="id" column="id" />
		<collection property="registeredDictList" ofType="Dictionary">
			<id property="id" column="dictionary_id" />
			<result property="name" column="dictionary_name"/>
		</collection>
	</resultMap>
	
	<select id="selectWordById" parameterType="Long" resultMap="joinedResult">
		SELECT 
			 dictionarys.id AS dictionary_id, dictionarys.name AS dictionary_name,
		     words.id AS id, words.name AS name, pronunciation, simple_description, detailed_description, reference_url,
		     registered_at, updated_at, last_view_at, page_views
		FROM 
			words
		JOIN
			dictionary_word
		ON
			 words.id = dictionary_word.word_id
		JOIN
			dictionarys
		ON
			dictionary_word.dictionary_id = dictionarys.id
		WHERE
			words.id = #{id}
	</select>
	
	<update id="incrementPageViews" parameterType="Long">
		UPDATE 
			words 
		SET 
			page_views = page_views + 1 
		WHERE 
			id = #{id};
	</update>
	
	<update id="updateWordLastViewedById" parameterType="Long">
		UPDATE 
			words 
		SET 
			last_view_at = CURRENT_TIMESTAMP
		WHERE 
			id = #{id}
	</update>
	
	<update id="updateWordByEditedWord" parameterType="Word">
		UPDATE 
			words
		SET 
			pronunciation = #{pronunciation},
		    simple_description = #{simpleDescription},
		    detailed_description = #{detailedDescription},
		    reference_url = #{referenceUrl},
		    updated_at = CURRENT_TIMESTAMP
		WHERE 
			id = #{id}
	</update>
	
	<delete id="deleteWordById" parameterType="Long">
		DELETE FROM
			words
		WHERE 
			id = #{id}
	</delete>
	
	<insert id="insertWord" parameterType="map">
		INSERT INTO 
			words (`user_id`, `name`, `pronunciation`, `simple_description`, `detailed_description`, `reference_url`) 
		VALUES(
			#{userId},
	        #{word.name},
	        #{word.pronunciation},
	        #{word.simpleDescription},
	        #{word.detailedDescription},
	        #{word.referenceUrl}
		)
	
	</insert>
	
	<select id="selectLastInsertedId" resultType="Long">
		SELECT 
			LAST_INSERT_ID()
	</select>
	
	<select id="countTotalWords" resultType="int">
	SELECT
		COUNT(id) AS total_words
	FROM
		words
	WHERE
		user_id = #{userId}
	</select>
	
		
</mapper>
